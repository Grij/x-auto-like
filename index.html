<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Auto Like Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.13/dist/modules/libsodium-wrappers.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [maxLikes, setMaxLikes] = useState(10);
            const [searchQuery, setSearchQuery] = useState("#python OR from:elonmusk -is:retweet");
            const [githubToken, setGithubToken] = useState("");
            const [status, setStatus] = useState("");
            const [runs, setRuns] = useState([]);
            const [stats, setStats] = useState([]);
            const [isLibsodiumReady, setIsLibsodiumReady] = useState(false);

            // Ініціалізація libsodium
            useEffect(() => {
                async function initLibsodium() {
                    await window.libsodium.ready;
                    setIsLibsodiumReady(true);
                }
                initLibsodium();
            }, []);

            // Завантаження історії запусків і статистики
            useEffect(() => {
                if (githubToken) {
                    axios.get("https://api.github.com/repos/grij/x-auto-like/actions/runs", {
                        headers: { Authorization: `Bearer ${githubToken}`, Accept: "application/vnd.github+json" }
                    })
                    .then(response => setRuns(response.data.workflow_runs.slice(0, 5)))
                    .catch(error => setStatus(`Помилка завантаження історії: ${error.message}`));

                    axios.get("https://raw.githubusercontent.com/grij/x-auto-like/main/stats.txt")
                    .then(response => setStats(response.data.split("\n").filter(line => line).slice(-5)))
                    .catch(error => setStatus(`Помилка завантаження статистики: ${error.message}`));
                }
            }, [githubToken]);

            // Оновлення секретів
            const updateSecrets = async () => {
                if (!isLibsodiumReady) {
                    setStatus("Помилка: libsodium ще не завантажено");
                    return;
                }
                setStatus("Оновлення налаштувань...");
                try {
                    const publicKey = "11QELOca26gUqMxELRNSb/6PqH3VS+MHlI7ahnZcAQE=";
                    const keyId = "3380204578043523366";

                    const encryptSecret = async (value) => {
                        const keyBytes = window.libsodium.from_base64(publicKey, window.libsodium.base64_variants.ORIGINAL);
                        const valueBytes = window.libsodium.from_string(value);
                        const encryptedBytes = window.libsodium.crypto_box_seal(valueBytes, keyBytes);
                        return window.libsodium.to_base64(encryptedBytes, window.libsodium.base64_variants.ORIGINAL);
                    };

                    // Оновлення MAX_LIKES_PER_DAY
                    await axios.put(
                        "https://api.github.com/repos/grij/x-auto-like/actions/secrets/MAX_LIKES_PER_DAY",
                        {
                            encrypted_value: await encryptSecret(maxLikes.toString()),
                            key_id: keyId
                        },
                        { headers: { Authorization: `Bearer ${githubToken}`, Accept: "application/vnd.github+json" } }
                    );

                    // Оновлення SEARCH_QUERY
                    await axios.put(
                        "https://api.github.com/repos/grij/x-auto-like/actions/secrets/SEARCH_QUERY",
                        {
                            encrypted_value: await encryptSecret(searchQuery),
                            key_id: keyId
                        },
                        { headers: { Authorization: `Bearer ${githubToken}`, Accept: "application/vnd.github+json" } }
                    );

                    setStatus("Налаштування успішно оновлено!");
                } catch (error) {
                    setStatus(`Помилка: ${error.message}`);
                }
            };

            // Запуск workflow
            const triggerWorkflow = async () => {
                setStatus("Запуск скрипта...");
                try {
                    await axios.post(
                        "https://api.github.com/repos/grij/x-auto-like/actions/workflows/like_tweets.yml/dispatches",
                        { ref: "main" },
                        { headers: { Authorization: `Bearer ${githubToken}`, Accept: "application/vnd.github+json" } }
                    );
                    setStatus("Скрипт успішно запущено!");
                } catch (error) {
                    setStatus(`Помилка: ${error.message}`);
                }
            };

            return (
                <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
                    <h1 className="text-2xl font-bold mb-4">X Auto Like Dashboard</h1>
                    <div className="mb-4">
                        <label className="block text-sm font-medium">GitHub Token</label>
                        <input
                            type="password"
                            value={githubToken}
                            onChange={e => setGithubToken(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded"
                            placeholder="Введіть GitHub PAT"
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-sm font-medium">Кількість лайків на день</label>
                        <input
                            type="number"
                            value={maxLikes}
                            onChange={e => setMaxLikes(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded"
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-sm font-medium">Пошуковий запит</label>
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded"
                            placeholder="Наприклад: #ukraine OR #технології"
                        />
                    </div>
                    <button
                        onClick={updateSecrets}
                        disabled={!isLibsodiumReady}
                        className={`w-full p-2 rounded mb-2 ${isLibsodiumReady ? "bg-blue-500 text-white hover:bg-blue-600" : "bg-gray-300 text-gray-500 cursor-not-allowed"}`}
                    >
                        Зберегти налаштування
                    </button>
                    <button
                        onClick={triggerWorkflow}
                        className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
                    >
                        Запустити скрипт
                    </button>
                    <p className="mt-4 text-sm">{status}</p>
                    <h2 className="mt-6 text-xl font-bold">Останні запуски</h2>
                    <ul className="mt-2">
                        {runs.map(run => (
                            <li key={run.id} className="text-sm">
                                {new Date(run.created_at).toLocaleString()}: {run.status} ({run.conclusion || "N/A"})
                            </li>
                        ))}
                    </ul>
                    <h2 className="mt-6 text-xl font-bold">Статистика лайків</h2>
                    <ul className="mt-2">
                        {stats.map((stat, index) => (
                            <li key={index} className="text-sm">{stat}</li>
                        ))}
                    </ul>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>
</html>
